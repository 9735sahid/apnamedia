<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apna Media</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-nav: #eab308;
      --accent-red: #ff0000;
      --bg-light: #f8fafc;
      --card-white: #ffffff;
      --text-dark: #1f2937;
      --text-gray: #6b7280;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      overflow-x: hidden;
      overscroll-behavior: none; /* Prevents pull-to-refresh on mobile while drawing */
    }
    
    .hidden {
      display: none !important;
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Auth Screen */
    #authScreen {
      min-height: 100vh;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .auth-card {
      background: var(--card-white);
      padding: 40px 30px;
      border-radius: 24px;
      box-shadow: var(--shadow-md);
      width: 100%;
      max-width: 400px;
    }
    
    .logo-text {
      font-size: 36px;
      font-weight: 700;
      text-align: center;
      background: linear-gradient(135deg, var(--bg-nav), #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 30px;
    }
    
    .auth-input {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      transition: border 0.3s;
    }
    
    .auth-input:focus {
      outline: none;
      border-color: var(--bg-nav);
    }
    
    .btn-primary {
      width: 100%;
      padding: 14px;
      background: var(--bg-nav);
      color: white;
      border: none;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-bottom: 12px;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-google {
      background: white;
      color: var(--text-dark);
      border: 2px solid #e5e7eb;
    }
    
    /* App View */
    #appView {
      padding-bottom: 80px;
    }
    
    /* Top Header */
    .top-header {
      background: var(--card-white);
      padding: 16px 20px;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .app-name {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--bg-nav), #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header-icon {
      font-size: 24px;
      color: var(--text-dark);
      cursor: pointer;
    }
    
    /* Search Bar */
    .search-container {
      padding: 12px 20px;
      background: var(--card-white);
      border-bottom: 1px solid #e5e7eb;
    }
    
    .search-box {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--bg-light);
      border-radius: 12px;
      padding: 10px 16px;
    }
    
    .search-input {
      flex: 1;
      border: none;
      background: transparent;
      font-family: 'Poppins', sans-serif;
      font-size: 15px;
      outline: none;
    }
    
    .search-results {
      background: var(--card-white);
      border-radius: 12px;
      margin-top: 8px;
      box-shadow: var(--shadow-md);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .search-result-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .search-result-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    /* Stories Rail */
    .stories-rail {
      background: var(--card-white);
      padding: 16px 0;
      overflow-x: auto;
      white-space: nowrap;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .story-item {
      display: inline-block;
      margin: 0 8px;
      text-align: center;
      cursor: pointer;
    }
    
    .story-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 3px solid var(--bg-nav);
      object-fit: cover;
    }
    
    .story-add {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--bg-light);
      border: 3px dashed var(--bg-nav);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      color: var(--bg-nav);
    }
    
    .story-username {
      font-size: 12px;
      margin-top: 6px;
      color: var(--text-gray);
      max-width: 70px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ------------------------------------------------ */
    /* UPDATED STORY EDITOR STYLES                      */
    /* ------------------------------------------------ */
    .story-editor {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      z-index: 2000;
      display: flex;
      flex-direction: column;
    }
    
    .story-editor-header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0,0,0,0.5);
      z-index: 20;
    }
    
    .story-editor-title {
      color: white;
      font-size: 18px;
      font-weight: 600;
    }
    
    .color-palette {
      display: flex;
      gap: 8px;
    }
    
    .color-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .color-dot:hover {
      transform: scale(1.2);
    }
    
    .story-editor-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: #111;
      width: 100%;
    }
    
    .story-editor-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      pointer-events: none; /* Let clicks pass through to canvas/text */
      z-index: 1;
    }
    
    /* Drawing Canvas */
    .drawing-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none; /* Enabled only when drawing mode is on */
    }
    
    .drawing-canvas.active {
      pointer-events: all;
      cursor: crosshair;
    }
    
    /* Text Overlay */
    .story-text-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); /* Start centered */
      min-width: 200px;
      z-index: 10;
      cursor: grab;
      user-select: none;
    }
    
    .story-text-overlay:active {
      cursor: grabbing;
    }
    
    .story-text-input {
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border-radius: 8px;
      border: 1px dashed rgba(255,255,255,0.5);
      cursor: text;
      width: 100%;
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      outline: none;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
    }
    
    /* Music Sticker */
    .music-sticker {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      color: black;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 5;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .story-editor-tools {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 20;
    }
    
    .story-tool-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    
    .story-tool-btn.active {
      background: var(--bg-nav);
      color: black;
      transform: scale(1.1);
    }
    
    .story-editor-footer {
      padding: 20px;
      background: rgba(0,0,0,0.5);
      z-index: 20;
    }
    
    .story-caption-input {
      width: 100%;
      background: transparent;
      border: none;
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      padding: 12px;
      outline: none;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      margin-bottom: 16px;
    }
    
    .story-caption-input::placeholder {
      color: rgba(255,255,255,0.6);
    }
    
    .story-share-options {
      display: flex;
      gap: 12px;
    }
    
    .story-share-btn {
      flex: 1;
      padding: 12px;
      border-radius: 24px;
      border: 2px solid white;
      background: transparent;
      color: white;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .story-share-btn.primary {
      background: white;
      color: #000;
    }
    
    /* ------------------------------------------------ */
    
    /* Story Viewer */
    .story-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #000;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .story-viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 2001;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .story-viewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid white;
      object-fit: cover;
    }
    
    .story-viewer-info {
      flex: 1;
      color: white;
    }
    
    .btn-close-story {
      color: white;
      font-size: 28px;
      cursor: pointer;
    }
    
    .story-viewer-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Feed & Posts */
    .feed-container { padding: 0; }
    .post-card {
      background: var(--card-white);
      margin-bottom: 16px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .post-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      justify-content: space-between;
    }
    .post-user-info { display: flex; align-items: center; flex: 1; }
    .post-avatar {
      width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover;
    }
    .post-username { font-weight: 600; font-size: 15px; }
    .post-image { width: 100%; cursor: pointer; user-select: none; }
    .post-actions { padding: 12px 16px; display: flex; gap: 16px; font-size: 24px; }
    .action-icon.liked { color: var(--accent-red); }
    .post-caption { padding: 0 16px 12px; font-size: 14px; }
    .btn-follow {
      padding: 6px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
    }
    .btn-follow.follow { background: var(--accent-red); color: white; }
    .btn-follow.following { background: #e5e7eb; color: var(--text-gray); }

    /* Bottom Nav */
    .nav-dock {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card-white); padding: 12px 0 8px;
      box-shadow: 0 -2px 16px rgba(0,0,0,0.1);
      border-radius: 24px 24px 0 0;
      display: flex; justify-content: space-around; align-items: center; z-index: 1000;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; cursor: pointer;
      padding: 8px 16px; transition: all 0.3s;
    }
    .nav-item.active i { color: var(--bg-nav); }
    .nav-item.center-btn {
      background: var(--bg-nav); width: 64px; height: 64px; border-radius: 50%;
      position: relative; bottom: 20px; box-shadow: 0 4px 16px rgba(234, 179, 8, 0.4);
    }
    .nav-item.center-btn i { color: white; font-size: 28px; margin: 0; }

    /* Profile Grid */
    .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
    .grid-image { width: 100%; aspect-ratio: 1; object-fit: cover; }
    
    /* Activity */
    .notification-item {
      background: var(--card-white); padding: 16px; margin-bottom: 12px;
      border-radius: 16px; display: flex; align-items: center; box-shadow: var(--shadow-sm);
    }
    .notification-icon {
      width: 40px; height: 40px; border-radius: 50%; background: var(--bg-nav);
      display: flex; align-items: center; justify-content: center; color: white; margin-right: 14px;
    }

    /* Chat Overlay */
    .chat-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-light); z-index: 1000; display: flex; flex-direction: column;
    }
    .messages-container { flex: 1; overflow-y: auto; padding: 16px; }
    .message-bubble {
      max-width: 70%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px;
    }
    .message-bubble.mine { background: var(--bg-nav); color: white; margin-left: auto; }
    .message-bubble.theirs { background: #e5e7eb; color: var(--text-dark); }
    .chat-input-container {
      background: var(--card-white); padding: 12px 16px; display: flex; gap: 12px;
    }
    .chat-input { flex: 1; padding: 12px 16px; border-radius: 24px; border: 1px solid #e5e7eb; }
    .btn-send {
        width: 48px; height: 48px; border-radius: 50%; background: var(--bg-nav); color: white; border: none; cursor: pointer;
    }

    /* Loader */
    .loader {
      display: inline-block; width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="authScreen">
    <div class="auth-card fade-in">
      <div class="logo-text">Apna Media</div>
      <input type="email" id="emailInput" class="auth-input" placeholder="Email">
      <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
      <button id="btnEmailAuth" class="btn-primary">Continue</button>
      <button id="btnGoogleAuth" class="btn-primary btn-google">
        <i class="fab fa-google"></i> Continue with Google
      </button>
    </div>
  </div>

  <div id="appView" class="hidden">
    <div id="homeView" class="view-container">
      <div class="top-header">
        <div class="app-name">Apna Media</div>
        <i class="fas fa-paper-plane header-icon" onclick="switchView('chat')"></i>
      </div>
      
      <div class="search-container">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" class="search-input" placeholder="Search users...">
        </div>
        <div id="searchResults" class="search-results hidden"></div>
      </div>
      
      <div class="stories-rail" id="storiesRail">
        <div class="story-item" onclick="handleStoryUpload()">
          <div class="story-add"><i class="fas fa-plus"></i></div>
          <div class="story-username">Your Story</div>
        </div>
      </div>
      
      <div class="feed-container" id="feedContainer"></div>
    </div>

    <div id="chatView" class="view-container hidden">
      <div class="top-header">
        <div class="app-name">Messages</div>
      </div>
      <div class="chat-list" id="chatList"></div>
    </div>

    <div id="uploadView" class="view-container hidden">
      <div class="top-header">
        <div class="app-name">Create Post</div>
      </div>
      <div class="upload-container" style="padding:20px;">
        <div class="dropzone" style="border:3px dashed var(--bg-nav); padding:60px 20px; text-align:center; border-radius:20px; background:white; cursor:pointer;" onclick="document.getElementById('fileInput').click()">
          <i class="fas fa-cloud-upload-alt" style="font-size:64px; color:var(--bg-nav);"></i>
          <div style="margin-top:16px; color:#6b7280;">Click to select an image</div>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
        <div id="previewContainer" class="hidden" style="margin-top:20px; text-align:center;">
          <img id="previewImage" style="max-width:100%; border-radius:20px; margin-bottom:16px;">
          <textarea id="captionInput" class="auth-input" placeholder="Write a caption..."></textarea>
          <button class="btn-primary" onclick="publishPost()">Publish</button>
        </div>
      </div>
    </div>

    <div id="activityView" class="view-container hidden">
      <div class="top-header">
        <div class="app-name">Activity</div>
      </div>
      <div class="activity-container" id="activityContainer" style="padding:16px;"></div>
    </div>

    <div id="profileView" class="view-container hidden">
      <div class="top-header">
        <div class="app-name">Profile</div>
        <i class="fas fa-sign-out-alt header-icon" onclick="handleLogout()"></i>
      </div>
      <div class="profile-container" style="padding:20px;">
        <div class="profile-header" style="text-align:center; margin-bottom:30px;">
          <img id="profilePic" src="" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:4px solid var(--bg-nav);" onclick="handleAvatarUpload()">
          <h2 id="profileUsername" style="font-size:24px; margin:16px 0;">Username</h2>
          <button class="btn-follow following" onclick="editProfile()">Edit Profile</button>
        </div>
        
        <div class="profile-stats" style="display:flex; justify-content:space-around; margin:30px 0; background:white; padding:20px; border-radius:20px;">
          <div class="stat-item" style="text-align:center;">
            <div id="postCount" style="font-size:24px; font-weight:700;">0</div>
            <div style="font-size:13px; color:#6b7280;">Posts</div>
          </div>
          <div class="stat-item" style="text-align:center;">
            <div id="followerCount" style="font-size:24px; font-weight:700;">0</div>
            <div style="font-size:13px; color:#6b7280;">Followers</div>
          </div>
          <div class="stat-item" style="text-align:center;">
            <div id="followingCount" style="font-size:24px; font-weight:700;">0</div>
            <div style="font-size:13px; color:#6b7280;">Following</div>
          </div>
        </div>
        
        <div class="profile-grid" id="profileGrid"></div>
      </div>
    </div>

    <div id="otherProfileView" class="view-container hidden">
      <div class="top-header">
          <i class="fas fa-arrow-left header-icon" onclick="closeOtherProfile()"></i>
        <div class="app-name" id="otherProfileTitle">Profile</div>
        <div></div>
      </div>
      <div class="profile-container" style="padding:20px;">
        <div class="profile-header" style="text-align:center;">
          <img id="otherProfilePic" src="" style="width:120px; height:120px; border-radius:50%; object-fit:cover;">
          <h2 id="otherProfileUsername" style="font-size:24px; margin:16px 0;">Username</h2>
          <button id="otherProfileFollowBtn" class="btn-follow follow" onclick="toggleOtherProfileFollow()">Follow</button>
        </div>
        <div class="profile-stats" style="display:flex; justify-content:space-around; margin:30px 0; background:white; padding:20px; border-radius:20px;">
            <div class="stat-item" style="text-align:center;">
                <div id="otherPostCount" style="font-size:24px; font-weight:700;">0</div>
                <div style="font-size:13px; color:#6b7280;">Posts</div>
            </div>
            <div class="stat-item" style="text-align:center;">
                <div id="otherFollowerCount" style="font-size:24px; font-weight:700;">0</div>
                <div style="font-size:13px; color:#6b7280;">Followers</div>
            </div>
            <div class="stat-item" style="text-align:center;">
                <div id="otherFollowingCount" style="font-size:24px; font-weight:700;">0</div>
                <div style="font-size:13px; color:#6b7280;">Following</div>
            </div>
        </div>
        <div class="profile-grid" id="otherProfileGrid"></div>
      </div>
    </div>

    <div class="nav-dock">
      <div class="nav-item active" onclick="switchView('home')">
        <i class="fas fa-home"></i>
        <span class="nav-label" style="font-size:11px;">Home</span>
      </div>
      <div class="nav-item" onclick="switchView('chat')">
        <i class="fas fa-comment-dots"></i>
        <span class="nav-label" style="font-size:11px;">Chat</span>
      </div>
      <div class="nav-item center-btn" onclick="switchView('upload')">
        <i class="fas fa-plus"></i>
      </div>
      <div class="nav-item" onclick="switchView('activity')">
        <i class="fas fa-heart"></i>
        <span class="nav-label" style="font-size:11px;">Activity</span>
        <span id="activityBadge" class="notification-badge hidden" style="background:red; color:white; border-radius:10px; padding:2px 6px; font-size:10px; position:absolute; top:4px; right:8px;">0</span>
      </div>
      <div class="nav-item" onclick="switchView('profile')">
        <i class="fas fa-user"></i>
        <span class="nav-label" style="font-size:11px;">Profile</span>
      </div>
    </div>
  </div>

  <div id="storyEditor" class="story-editor hidden">
    <div class="story-editor-header">
      <i class="fas fa-times" style="color: white; font-size: 24px; cursor: pointer;" onclick="closeStoryEditor()"></i>
      <div class="story-editor-title">Editor</div>
      <div id="colorPalette" class="color-palette hidden">
        <div class="color-dot" style="background: #ff0000;" onclick="setBrushColor('#ff0000')"></div>
        <div class="color-dot" style="background: #00ff00;" onclick="setBrushColor('#00ff00')"></div>
        <div class="color-dot" style="background: #0000ff;" onclick="setBrushColor('#0000ff')"></div>
        <div class="color-dot" style="background: #ffff00;" onclick="setBrushColor('#ffff00')"></div>
        <div class="color-dot" style="background: #ffffff;" onclick="setBrushColor('#ffffff')"></div>
        <div class="color-dot" style="background: #000000;" onclick="setBrushColor('#000000')"></div>
      </div>
    </div>
  
    <div class="story-editor-content" id="storyContentArea">
      <img id="storyEditorImage" class="story-editor-image" src="">
      
      <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
  
      <div id="storyTextOverlay" class="story-text-overlay hidden">
        <input type="text" id="storyTextInput" class="story-text-input" placeholder="Type here...">
      </div>
  
      <div id="musicSticker" class="music-sticker hidden">
        <i class="fas fa-music"></i> <span>Now Playing: Viral Song</span>
      </div>
  
      <div class="story-editor-tools">
        <button class="story-tool-btn" onclick="toggleStoryText()" title="Text"><i class="fas fa-font"></i></button>
        <button class="story-tool-btn" onclick="toggleDrawingMode()" title="Draw"><i class="fas fa-pen"></i></button>
        <button class="story-tool-btn" onclick="changeStoryFilter()" title="Filter"><i class="fas fa-magic"></i></button>
        <button class="story-tool-btn" onclick="toggleMusic()" title="Music"><i class="fas fa-music"></i></button>
      </div>
    </div>
  
    <div class="story-editor-footer">
      <input type="text" id="storyCaptionInput" class="story-caption-input" placeholder="Add a caption...">
      <div class="story-share-options">
        <button class="story-share-btn" onclick="closeStoryEditor()">
          <i class="fas fa-trash"></i> Discard
        </button>
        <button class="story-share-btn primary" onclick="shareStory()">
          <i class="fas fa-paper-plane"></i> Share Story
        </button>
      </div>
    </div>
  </div>

  <div id="chatOverlay" class="chat-overlay hidden">
    <div class="chat-input-container" style="background:white; border-bottom:1px solid #e5e7eb; padding:16px;">
      <i class="fas fa-arrow-left btn-back" style="font-size:20px; cursor:pointer;" onclick="closeChatOverlay()"></i>
      <img id="chatHeaderAvatar" style="width:40px; height:40px; border-radius:50%; margin-left:12px; margin-right:12px;">
      <div class="chat-header-name" id="chatHeaderName" style="font-weight:600; font-size:18px;">Chat</div>
    </div>
    <div class="messages-container" id="messagesContainer"></div>
    <div class="chat-input-container">
      <input type="text" id="messageInput" class="chat-input" placeholder="Type a message...">
      <button class="btn-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>

  <div id="storyViewer" class="story-viewer hidden">
    <div class="story-viewer-header">
      <img id="storyViewerAvatar" class="story-viewer-avatar" src="">
      <div class="story-viewer-info">
        <div class="story-viewer-username" id="storyViewerUsername">Username</div>
        <div class="story-viewer-time" id="storyViewerTime">2h ago</div>
      </div>
      <i class="fas fa-times btn-close-story" onclick="closeStoryViewer()"></i>
    </div>
    <img id="storyViewerImage" class="story-viewer-image" src="">
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getDatabase, ref, set, push, onValue, update, query, orderByChild, limitToLast, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCBEnLzD1hM80AANRrlTiphuVJjdBgXEyw",
      authDomain: "apnamedia-9110f.firebaseapp.com",
      databaseURL: "https://apnamedia-9110f-default-rtdb.firebaseio.com",
      projectId: "apnamedia-9110f",
      storageBucket: "apnamedia-9110f.firebasestorage.app",
      messagingSenderId: "980007622252",
      appId: "1:980007622252:web:a8587d2439d161a5beaa49"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    
    let currentUser = null;
    let currentView = 'home';
    let currentChatUser = null;
    let currentChatType = null;
    let uploadedImageData = null;
    let storyImageData = null;
    let currentOtherUserId = null;
    let storyTextVisible = false;
    let filterIndex = 0;

    // --- STORY EDITOR VARIABLES ---
    let isDrawingMode = false;
    let isMusicActive = false;
    let canvas, ctx;
    let brushColor = '#ff0000';
    let isDrawing = false;
    let isDraggingText = false;
    let textDragStartX, textDragStartY;
    let textPosX = 0, textPosY = 0;

    // Image Helper
    function processImage(file, maxWidth = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // --- AUTH LOGIC ---
    document.getElementById('btnEmailAuth').addEventListener('click', async () => {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      if (!email || !password) return alert('Enter email and password');
      
      const btn = document.getElementById('btnEmailAuth');
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span>';
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
          try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            await updateProfile(user, { displayName: email.split('@')[0], photoURL: `https://ui-avatars.com/api/?name=${email.split('@')[0]}&background=eab308&color=fff` });
            await initializeUserProfile(user);
          } catch (e) { alert(e.message); }
        } else { alert(error.message); }
      }
      btn.disabled = false; btn.textContent = 'Continue';
    });

    document.getElementById('btnGoogleAuth').addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, new GoogleAuthProvider());
        await initializeUserProfile(result.user);
      } catch (error) { console.error(error); }
    });

    async function initializeUserProfile(user) {
      const userRef = ref(db, `users/${user.uid}`);
      const snapshot = await get(userRef);
      if (!snapshot.exists()) {
        await set(userRef, { uid: user.uid, username: user.displayName || 'User', photo: user.photoURL, email: user.email });
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('appView').classList.remove('hidden');
        loadApp();
      } else {
        currentUser = null;
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('appView').classList.add('hidden');
      }
    });

    window.handleLogout = () => confirm('Logout?') && signOut(auth);

    // --- NAVIGATION ---
    window.switchView = function(viewName) {
      ['home', 'chat', 'upload', 'activity', 'profile'].forEach(v => document.getElementById(v + 'View').classList.add('hidden'));
      document.getElementById(viewName + 'View').classList.remove('hidden');
      document.getElementById(viewName + 'View').classList.add('fade-in');
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      event.currentTarget.classList.add('active');
      currentView = viewName;
      
      if (viewName === 'home') loadFeed();
      if (viewName === 'chat') loadChatList();
      if (viewName === 'activity') loadActivity();
      if (viewName === 'profile') loadProfile();
    };

    function loadApp() {
      loadFeed(); loadStories(); listenForNotifications(); setupSearch();
    }

    // --- STORY LOGIC (IMPROVED) ---
    window.handleStoryUpload = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          storyImageData = await processImage(file);
          const img = document.getElementById('storyEditorImage');
          img.onload = () => { setupCanvas(); };
          img.src = storyImageData;
          filterIndex = 0; img.style.filter = 'none';
          document.getElementById('storyEditor').classList.remove('hidden');
          resetTextPosition();
        }
      };
      input.click();
    };

    function setupCanvas() {
      const img = document.getElementById('storyEditorImage');
      canvas = document.getElementById('drawingCanvas');
      ctx = canvas.getContext('2d');
      const container = document.getElementById('storyContentArea');
      canvas.width = container.offsetWidth;
      canvas.height = container.offsetHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = 5; ctx.strokeStyle = brushColor;
      
      canvas.addEventListener('mousedown', startDraw);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDraw);
      canvas.addEventListener('touchstart', startDraw);
      canvas.addEventListener('touchmove', draw);
      canvas.addEventListener('touchend', stopDraw);
    }

    window.toggleDrawingMode = function() {
      isDrawingMode = !isDrawingMode;
      const canvasEl = document.getElementById('drawingCanvas');
      const palette = document.getElementById('colorPalette');
      if (isDrawingMode) {
        canvasEl.classList.add('active');
        palette.classList.remove('hidden');
        document.querySelectorAll('.story-tool-btn')[1].classList.add('active');
      } else {
        canvasEl.classList.remove('active');
        palette.classList.add('hidden');
        document.querySelectorAll('.story-tool-btn')[1].classList.remove('active');
      }
    };

    window.setBrushColor = function(color) {
      brushColor = color; if(ctx) ctx.strokeStyle = brushColor;
    };

    function startDraw(e) {
      if (!isDrawingMode) return;
      isDrawing = true; draw(e);
    }
    function draw(e) {
      if (!isDrawing || !isDrawingMode) return;
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    }
    function stopDraw() { isDrawing = false; ctx.beginPath(); }

    window.toggleStoryText = function() {
      const overlay = document.getElementById('storyTextOverlay');
      storyTextVisible = !storyTextVisible;
      if (storyTextVisible) {
        overlay.classList.remove('hidden');
        document.getElementById('storyTextInput').focus();
        setupDraggableText();
      } else { overlay.classList.add('hidden'); }
    };

    function resetTextPosition() {
      const overlay = document.getElementById('storyTextOverlay');
      overlay.style.top = '50%'; overlay.style.left = '50%'; overlay.style.transform = 'translate(-50%, -50%)';
    }

    function setupDraggableText() {
      const overlay = document.getElementById('storyTextOverlay');
      overlay.onmousedown = dragStart; overlay.ontouchstart = dragStart;
      function dragStart(e) {
        if(e.target.tagName === 'INPUT') return;
        e.preventDefault(); isDraggingText = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        textDragStartX = clientX - overlay.offsetLeft;
        textDragStartY = clientY - overlay.offsetTop;
        document.onmouseup = dragEnd; document.onmousemove = dragAction;
        document.ontouchend = dragEnd; document.ontouchmove = dragAction;
      }
      function dragAction(e) {
        if (!isDraggingText) return;
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        overlay.style.left = (clientX - textDragStartX) + "px";
        overlay.style.top = (clientY - textDragStartY) + "px";
        overlay.style.transform = 'none';
      }
      function dragEnd() {
        isDraggingText = false;
        document.onmouseup = null; document.onmousemove = null;
        document.ontouchend = null; document.ontouchmove = null;
      }
    }

    window.toggleMusic = function() {
      const sticker = document.getElementById('musicSticker');
      isMusicActive = !isMusicActive;
      isMusicActive ? sticker.classList.remove('hidden') : sticker.classList.add('hidden');
    };

    window.changeStoryFilter = function() {
      const filters = ['none', 'grayscale(100%)', 'sepia(100%)', 'brightness(1.5)', 'contrast(1.5)', 'hue-rotate(90deg)'];
      filterIndex = (filterIndex + 1) % filters.length;
      document.getElementById('storyEditorImage').style.filter = filters[filterIndex];
    };

    window.shareStory = async function() {
      const btn = document.querySelector('.story-share-btn.primary');
      btn.innerHTML = '<span class="loader"></span> Saving...';
      
      const img = document.getElementById('storyEditorImage');
      const drawingCanvas = document.getElementById('drawingCanvas');
      const textInput = document.getElementById('storyTextInput');
      const musicSticker = document.getElementById('musicSticker');
      
      const finalCanvas = document.createElement('canvas');
      const ctxFinal = finalCanvas.getContext('2d');
      finalCanvas.width = drawingCanvas.width;
      finalCanvas.height = drawingCanvas.height;
      
      // Draw Image
      ctxFinal.filter = img.style.filter;
      const hRatio = finalCanvas.width / img.naturalWidth;
      const vRatio = finalCanvas.height / img.naturalHeight;
      const ratio  = Math.min(hRatio, vRatio);
      const centerShift_x = (finalCanvas.width - img.naturalWidth * ratio) / 2;
      const centerShift_y = (finalCanvas.height - img.naturalHeight * ratio) / 2; 
      ctxFinal.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, centerShift_x, centerShift_y, img.naturalWidth*ratio, img.naturalHeight*ratio);
      
      // Draw Canvas
      ctxFinal.filter = 'none';
      ctxFinal.drawImage(drawingCanvas, 0, 0);
      
      // Draw Text
      if (storyTextVisible && textInput.value.trim()) {
        const fontSize = 28;
        ctxFinal.font = `bold ${fontSize}px Poppins`;
        ctxFinal.fillStyle = 'white';
        ctxFinal.textAlign = 'center';
        ctxFinal.shadowColor = 'black';
        ctxFinal.shadowBlur = 4;
        const rect = textInput.getBoundingClientRect();
        const containerRect = document.getElementById('storyContentArea').getBoundingClientRect();
        const x = rect.left - containerRect.left + (rect.width / 2);
        const y = rect.top - containerRect.top + fontSize; 
        ctxFinal.fillText(textInput.value, x, y);
      }

      // Draw Music
      if (isMusicActive) {
        const stickerRect = musicSticker.getBoundingClientRect();
        const containerRect = document.getElementById('storyContentArea').getBoundingClientRect();
        const x = stickerRect.left - containerRect.left + 10;
        const y = stickerRect.top - containerRect.top + 25;
        ctxFinal.fillStyle = 'white';
        ctxFinal.beginPath();
        // Fallback for roundRect if needed
        if(ctxFinal.roundRect) {
            ctxFinal.roundRect(x - 10, y - 20, stickerRect.width, stickerRect.height, 20);
        } else {
            ctxFinal.rect(x - 10, y - 20, stickerRect.width, stickerRect.height);
        }
        ctxFinal.fill();
        ctxFinal.fillStyle = 'black';
        ctxFinal.font = '600 14px Poppins';
        ctxFinal.textAlign = 'left';
        ctxFinal.fillText('ðŸŽµ Now Playing: Viral Song', x, y);
      }
      
      const finalImage = finalCanvas.toDataURL('image/jpeg', 0.85);
      await set(push(ref(db, 'stories')), {
        image: finalImage, uid: currentUser.uid, timestamp: Date.now(), caption: document.getElementById('storyCaptionInput').value || ''
      });
      
      closeStoryEditor();
      btn.innerHTML = '<i class="fas fa-paper-plane"></i> Share Story';
      alert('Story added!');
    };

    window.closeStoryEditor = function() {
      document.getElementById('storyEditor').classList.add('hidden');
      document.getElementById('storyCaptionInput').value = '';
      document.getElementById('storyTextOverlay').classList.add('hidden');
      document.getElementById('storyTextInput').value = '';
      storyTextVisible = false;
      isDrawingMode = false;
      if(canvas) { canvas.getContext('2d').clearRect(0,0,canvas.width, canvas.height); canvas.classList.remove('active'); }
      isMusicActive = false;
      document.getElementById('musicSticker').classList.add('hidden');
      document.getElementById('colorPalette').classList.add('hidden');
      document.querySelectorAll('.story-tool-btn').forEach(btn => btn.classList.remove('active'));
    };

    // --- OTHER LOGIC (Feed, Chat, etc.) ---
    async function loadStories() {
      const storiesRef = ref(db, 'stories');
      onValue(storiesRef, async (snapshot) => {
        const rail = document.getElementById('storiesRail');
        rail.innerHTML = `<div class="story-item" onclick="handleStoryUpload()"><div class="story-add"><i class="fas fa-plus"></i></div><div class="story-username">Your Story</div></div>`;
        if (snapshot.exists()) {
          const stories = snapshot.val();
          const storyUserIds = new Set();
          Object.values(stories).forEach(s => s.uid !== currentUser.uid && storyUserIds.add(s.uid));
          for (let uid of storyUserIds) {
            const userSnap = await get(ref(db, `users/${uid}`));
            if (userSnap.exists()) {
              rail.innerHTML += `<div class="story-item" onclick='viewUserStory("${uid}")'><img src="${userSnap.val().photo}" class="story-avatar"><div class="story-username">${userSnap.val().username}</div></div>`;
            }
          }
        }
      });
    }

    window.viewUserStory = async function(userId) {
      const snapshot = await get(ref(db, 'stories'));
      if (snapshot.exists()) {
        const stories = Object.values(snapshot.val()).filter(s => s.uid === userId);
        if (stories.length > 0) {
          const story = stories[stories.length - 1]; // Show latest
          const userSnap = await get(ref(db, `users/${userId}`));
          document.getElementById('storyViewerAvatar').src = userSnap.val().photo;
          document.getElementById('storyViewerUsername').textContent = userSnap.val().username;
          document.getElementById('storyViewerImage').src = story.image;
          document.getElementById('storyViewerTime').textContent = new Date(story.timestamp).toLocaleTimeString();
          document.getElementById('storyViewer').classList.remove('hidden');
        }
      }
    };
    window.closeStoryViewer = () => document.getElementById('storyViewer').classList.add('hidden');

    async function loadFeed() {
      onValue(query(ref(db, 'posts'), orderByChild('timestamp'), limitToLast(30)), async (snapshot) => {
        const container = document.getElementById('feedContainer');
        container.innerHTML = '';
        if (!snapshot.exists()) return container.innerHTML = '<div style="text-align:center; padding:40px; color:#6b7280;">No posts yet</div>';
        const posts = [];
        snapshot.forEach(c => posts.push({id: c.key, ...c.val()}));
        for(let post of posts.reverse()) {
          const userSnap = await get(ref(db, `users/${post.uid}`));
          const isLiked = post.likes && post.likes[currentUser.uid];
          container.innerHTML += `
            <div class="post-card">
              <div class="post-header">
                <div class="post-user-info">
                  <img src="${userSnap.val().photo}" class="post-avatar" onclick="viewUserProfile('${post.uid}')">
                  <div class="post-username">${userSnap.val().username}</div>
                </div>
              </div>
              <img src="${post.image}" class="post-image" ondblclick="likePost('${post.id}')">
              <div class="post-actions">
                <i class="fas fa-heart action-icon ${isLiked ? 'liked' : ''}" onclick="likePost('${post.id}')"></i>
              </div>
              <div class="post-caption"><span class="caption-username">${userSnap.val().username}</span> ${post.caption || ''}</div>
            </div>`;
        }
      });
    }

    window.likePost = async function(postId) {
      const likeRef = ref(db, `posts/${postId}/likes/${currentUser.uid}`);
      const snap = await get(likeRef);
      if(snap.exists()) { await set(likeRef, null); }
      else { await set(likeRef, true); }
    };

    // Chat
    async function loadChatList() {
      const container = document.getElementById('chatList');
      container.innerHTML = `<div class="chat-item" onclick="openChat('global', 'Global Channel')"><div class="chat-avatar" style="background:var(--bg-nav);display:flex;align-items:center;justify-content:center;"><i class="fas fa-users" style="color:white"></i></div><div class="chat-info"><div class="chat-name">Global Channel</div></div></div>`;
      const usersSnap = await get(ref(db, 'users'));
      if (usersSnap.exists()) {
        Object.values(usersSnap.val()).forEach(u => {
          if (u.uid !== currentUser.uid) container.innerHTML += `<div class="chat-item" onclick="openChat('${u.uid}', '${u.username}')"><img src="${u.photo}" class="chat-avatar"><div class="chat-info"><div class="chat-name">${u.username}</div></div></div>`;
        });
      }
    }

    window.openChat = async function(uid, name) {
      currentChatUser = uid; currentChatType = uid === 'global' ? 'global' : 'private';
      document.getElementById('chatHeaderName').textContent = name;
      document.getElementById('chatHeaderAvatar').src = uid === 'global' ? 'https://ui-avatars.com/api/?name=G' : (await get(ref(db, `users/${uid}`))).val().photo;
      document.getElementById('chatOverlay').classList.remove('hidden');
      loadMessages();
    };

    window.closeChatOverlay = () => document.getElementById('chatOverlay').classList.add('hidden');

    function loadMessages() {
      const path = currentChatType === 'global' ? 'chats' : `private_chats/${[currentUser.uid, currentChatUser].sort().join('_')}`;
      onValue(query(ref(db, path), orderByChild('timestamp'), limitToLast(50)), (snap) => {
        const div = document.getElementById('messagesContainer');
        div.innerHTML = '';
        if(snap.exists()) {
          snap.forEach(c => {
            const m = c.val();
            div.innerHTML += `<div class="message-bubble ${m.uid === currentUser.uid ? 'mine' : 'theirs'}">${m.text}</div>`;
          });
          div.scrollTop = div.scrollHeight;
        }
      });
    }

    window.sendMessage = async function() {
      const txt = document.getElementById('messageInput').value.trim();
      if(!txt) return;
      const path = currentChatType === 'global' ? 'chats' : `private_chats/${[currentUser.uid, currentChatUser].sort().join('_')}`;
      await push(ref(db, path), { text: txt, uid: currentUser.uid, timestamp: Date.now() });
      document.getElementById('messageInput').value = '';
    };

    // Upload Post
    document.getElementById('fileInput').addEventListener('change', async (e) => {
      if(e.target.files[0]) {
        uploadedImageData = await processImage(e.target.files[0]);
        document.getElementById('previewImage').src = uploadedImageData;
        document.getElementById('previewContainer').classList.remove('hidden');
      }
    });

    window.publishPost = async function() {
      if(!uploadedImageData) return;
      await push(ref(db, 'posts'), {
        image: uploadedImageData, caption: document.getElementById('captionInput').value, uid: currentUser.uid, timestamp: Date.now()
      });
      uploadedImageData = null; document.getElementById('previewContainer').classList.add('hidden');
      switchView('home');
    };

    // Search
    function setupSearch() {
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const q = e.target.value.toLowerCase();
            const res = document.getElementById('searchResults');
            if(!q) return res.classList.add('hidden');
            const snap = await get(ref(db, 'users'));
            res.innerHTML = '';
            if(snap.exists()) {
                Object.values(snap.val()).forEach(u => {
                    if(u.username.toLowerCase().includes(q) && u.uid !== currentUser.uid) {
                        res.innerHTML += `<div class="search-result-item" onclick="viewUserProfile('${u.uid}')"><img src="${u.photo}" class="search-result-avatar"><div>${u.username}</div></div>`;
                    }
                });
                res.classList.remove('hidden');
            }
        });
    }

    // Profile
    async function loadProfile() {
      const u = (await get(ref(db, `users/${currentUser.uid}`))).val();
      document.getElementById('profilePic').src = u.photo;
      document.getElementById('profileUsername').textContent = u.username;
      // Simple stats mock
      document.getElementById('postCount').textContent = '0'; // Real count needs query
    }

    window.viewUserProfile = async function(uid) {
        if(uid === currentUser.uid) return switchView('profile');
        currentOtherUserId = uid;
        document.getElementById('homeView').classList.add('hidden');
        document.getElementById('otherProfileView').classList.remove('hidden');
        const u = (await get(ref(db, `users/${uid}`))).val();
        document.getElementById('otherProfilePic').src = u.photo;
        document.getElementById('otherProfileUsername').textContent = u.username;
    };

    window.closeOtherProfile = function() {
        document.getElementById('otherProfileView').classList.add('hidden');
        document.getElementById('homeView').classList.remove('hidden');
    };

    function listenForNotifications() {} // Placeholder
  </script>
</body>
</html>
